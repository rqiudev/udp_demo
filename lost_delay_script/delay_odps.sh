#!/bin/bash
cd `dirname $0`
if [ $# -lt 1 ];then
        echo 'please input max day'
        exit 1
fi


max_day=$1

#for ((i=1; i<=$max_day; ++i))
#do
#	tmp_date=`date -d "$i day ago" +'%Y-%m-%d'`
#	if [ $i -eq 1 ];then
#		days=" dt='$tmp_date' "
#		join_days=" r.dt='$tmp_date' "
#	else
#		days=" $days or dt='$tmp_date' "
#		join_days=" $join_days or r.dt='$tmp_date' "
#	fi
#done

end_day=`date +'%Y-%m-%d'`
start_day=`date -d "$max_day day ago" +'%Y-%m-%d'`

days="( dt>='$start_day' and dt<'$end_day' )"
join_days="( r.dt>='$start_day' and r.dt<'$end_day')"

tday=`date +'%Y-%m-%d'`
tday_str=`date +'%Y%m%d'`

#保存引擎导出delay大于400的临时表
#tmp_tables_name=t_andrew_liao_${tday_str}_tmp_yq
#从引擎表里提取delay大于400的callid并插入临时表中
#保存引擎临时表与rtpp表join的临时数据
tmp_table_name_m=t_andrew_liao_${tday_str}_tmp_m_statis
#join引擎临时表,rtpp, ip表


echo "SET odps.stage.mapper.split.size = 16;create table $tmp_table_name_m as select r.dt, get_json_object(r.content,'$.content.tags.c_c_id') as call_id, get_json_object(r.content,'$.content.tags.call_mode') as call_mode, get_json_object(r.content,'$.content.tags.last_rtpp') as last_rtpp, get_json_object(r.content,'$.content.tags.timeout_flag') as timeout, get_json_object(r.content,'$.content.tags.sessions_active') as max_sess, get_json_object(r.content,'$.content.tags.caller_rtpp_isp[0]') as rtpp_carriers, get_json_object(r.content,'$.content.tags.caller_rtpp_isp[1]') as rtpp_area, get_json_object(r.content,'$.content.tags.caller_pkg_addr[0]') as caller_addr, g.province as caller_province, g.city as caller_city, g.provider as caller_provider, get_json_object(r.content,'$.content.tags.callee_pkg_addr[0]') as callee_addr, p.province as callee_province, p.city as callee_city, p.provider as callee_provider, e.caller_rtcp_send, e.caller_rtcp_receive, e.caller_delay, e.caller_netmode, e.caller_xchg_p2p_cnt, e.caller_swithnet, e.caller_swithnet_info,e.caller_ping_delay1,e.caller_ping_delay2,e.caller_ping_delay3, f.callee_rtcp_send, f.callee_rtcp_receive, f.callee_delay, f.callee_netmode, f.callee_xchg_p2p_cnt, f.callee_swithnet, f.callee_swithnet_info, f.callee_ping_delay1,f.callee_ping_delay2,f.callee_ping_delay3 from ods_uxinapp_rtpp_d r inner join (select get_calid(get_json_object(content,'$.callupload[0].ugocallinfo.signaltrace'),get_json_object(content,'$.callupload[0].calleephone')) as callid, get_json_object(content,'$.callupload[0].qosinfo.rtcp_send') as caller_rtcp_send, get_json_object(content,'$.callupload[0].qosinfo.rtcp_receive') as caller_rtcp_receive, get_json_object(content, '$.callupload[0].qosinfo.delay') as caller_delay, get_json_object(content,'$.callupload[0].netmode') as caller_netmode, get_json_object(content,'$.callupload[0].iceinfo.switch_cnt') as caller_xchg_p2p_cnt, get_jsonarray_len(get_json_object(content, '$.callupload[0].netstat')) as caller_swithnet, get_jsonarray_info(get_json_object(content, '$.callupload[0].netstat'),'netmd') as caller_swithnet_info, get_json_object(content,'$.callupload[0].candrtppinfo[0].d') as caller_ping_delay1, get_json_object(content,'$.callupload[0].candrtppinfo[1].d') as caller_ping_delay2, get_json_object(content,'$.callupload[0].candrtppinfo[2].d') as caller_ping_delay3 from ods_uxinapp_realreport_d where $days and get_json_object(content,'$.callupload[0].role')='caller' and get_json_object(content,'$.callupload[0].ugocallinfo.signaltrace') like '%request%<-req ack%<-ring%<-rsp(aerr:0%' and get_json_object(content,'$.callupload[0].ugocallinfo.signaltrace') not like '%notify%' and split_part(get_json_object(content, '$.callupload[0].qosinfo.delay'), ',', 3) >= 400 and split_part(get_json_object(content, '$.callupload[0].qosinfo.delay'), ',', 2) >= 400) e on get_json_object(r.content,'$.content.tags.c_c_id')=e.callid left outer join (select get_calid(get_json_object(content,'$.callupload[0].ugocallinfo.signaltrace'),get_json_object(content,'$.callupload[0].calleephone')) as callid, get_json_object(content,'$.callupload[0].qosinfo.rtcp_send') as callee_rtcp_send, get_json_object(content,'$.callupload[0].qosinfo.rtcp_receive') as callee_rtcp_receive, get_json_object(content,'$.callupload[0].qosinfo.delay') as callee_delay, get_json_object(content,'$.callupload[0].netmode') as callee_netmode, get_json_object(content,'$.callupload[0].iceinfo.switch_cnt') as callee_xchg_p2p_cnt, get_jsonarray_len(get_json_object(content, '$.callupload[0].netstat')) as callee_swithnet, get_jsonarray_info(get_json_object(content, '$.callupload[0].netstat'),'netmd') as callee_swithnet_info, get_json_object(content,'$.callupload[0].candrtppinfo[0].d') as callee_ping_delay1, get_json_object(content,'$.callupload[0].candrtppinfo[1].d') as callee_ping_delay2, get_json_object(content,'$.callupload[0].candrtppinfo[2].d') as callee_ping_delay3 from ods_uxinapp_realreport_d where $days and get_json_object(content,'$.callupload[0].role')='callee' and split_part(get_json_object(content, '$.callupload[0].qosinfo.delay'), ',', 3) >= 400 and split_part(get_json_object(content, '$.callupload[0].qosinfo.delay'), ',', 2) >= 400) f on get_json_object(r.content,'$.content.tags.c_c_id')=f.callid left outer join ods_ip_info_n g on get_json_object(r.content,'$.content.tags.caller_pkg_addr[0]')=g.ip left outer join  ods_ip_info_n p on get_json_object(r.content,'$.content.tags.callee_pkg_addr[0]')=p.ip where $join_days and get_json_object(r.content,'$.content.tags.last_rtpp')=1;"|odpscmd


#echo "SET odps.stage.mapper.split.size = 16;select t2g.dt, t2g.total,tall.xcah0, round((tall.xcah0/total)*100, 2) as prexchx0, tall.xcah1, round((tall.xcah1/total)*100, 2) as prexchx1,tall.xcah2, round((tall.xcah2/total)*100, 2) as prexchx2, tall.xcah3, round((tall.xcah3/total)*100, 2) as prexchx2, tall.xcah4, round((tall.xcah4/total)*100, 2) as prexchx3, tall.xcah5, round((tall.xcah5/total)*100, 2) as prexchx3, tall.xcah_gt5, round((tall.xcah_gt5/total)*100, 2) as prexchgt5, d.d400_all, round((d.d400_all/total)*100, 2) as predelay400_pin3, txch.valxch, round((txch.valxch/total)*100, 2) as prexch, t2g.val2G, round((t2g.val2G/total)*100, 2) as pre2g, tyd3g.valyd3G, round((tyd3g.valyd3G/total)*100, 2) as preyd3G, t3g.val3G, round((t3g.val3G/total)*100, 2) as pre3g, t4g.val4G, round((t4g.val4G/total)*100, 2) as pre4g, twifi.valwifi, round((twifi.valwifi/total)*100, 2) as prewifi, tok.valok, round((tok.valok/total)*100, 2) as preok from (SELECT dt, count(DISTINCT call_id) AS total, count(distinct if(coalesce(caller_swithnet, 0)=0 and coalesce(callee_swithnet,0)=0 and (caller_netmode='2g' OR callee_netmode='2g'),call_id,null)) as val2G FROM $tmp_table_name_m group by dt) t2g left outer join  (SELECT count(distinct if(coalesce(caller_swithnet, 0)>0 or coalesce(callee_swithnet,0)>0,call_id,null)) as valxch, dt FROM $tmp_table_name_m group by dt)  txch on t2g.dt= txch.dt left outer join (SELECT count(distinct if(coalesce(caller_swithnet,0)=0 and coalesce(callee_swithnet,0)=0 and ( (caller_netmode='3g' and caller_provider like '移动') or (callee_netmode='3g' and callee_provider like '移动')) ,call_id,null)) as valyd3G, dt FROM $tmp_table_name_m group by dt) tyd3g  on tyd3g.dt = txch.dt left outer join (SELECT count(distinct if(coalesce(caller_swithnet,0)=0 and callee_swithnet=0 and ( (caller_netmode='3g' and caller_provider not like '移动') and (callee_netmode='3g' and callee_provider not like '移动')) ,call_id,null)) as val3G, dt FROM $tmp_table_name_m group by dt) t3g on t3g.dt=tyd3g.dt left outer join (SELECT count(distinct if(coalesce(caller_swithnet,0)=0 and coalesce(callee_swithnet,0)=0 and caller_netmode='4g'  and callee_netmode='4g' ,call_id,null)) as val4G, dt FROM $tmp_table_name_m group by dt) t4g on t4g.dt=t3g.dt left outer join (SELECT count(distinct if(coalesce(caller_swithnet,0)=0 and coalesce(callee_swithnet,0)=0 and caller_netmode='wifi'  and callee_netmode='wifi' ,call_id,null)) as valwifi,dt FROM $tmp_table_name_m group by dt) twifi on t4g.dt=twifi.dt  left outer join (SELECT count(distinct if(coalesce(caller_swithnet,0)=0 and coalesce(callee_swithnet,0)=0 and (caller_netmode='wifi' or caller_netmode='4g' or (caller_netmode='3g' and caller_provider not like '移动') ) and (callee_netmode='wifi' or callee_netmode='4g' or (callee_netmode='3g' and callee_provider not like '移动') ), call_id, null)) as valok, dt FROM $tmp_table_name_m group by dt ) tok on tok.dt=twifi.dt left outer join (select ts.dt,sum(if(ts.total=0, 1, 0)) as  xcah0, sum(if(ts.total=1, 1, 0)) as xcah1, sum(if(ts.total=2, 1, 0)) as xcah2, sum(if(ts.total=3, 1, 0)) as xcah3,sum(if(ts.total=4, 1, 0)) as xcah4, sum(if(ts.total=5, 1, 0)) as xcah5, sum(if(ts.total>5, 1, 0)) as xcah_gt5 from  (SELECT dt, (coalesce(caller_swithnet, 0) + coalesce(callee_swithnet, 0)) as total from $tmp_table_name_m) ts group by ts.dt) tall on tall.dt=tok.dt left outer join(select ts.dt as dt, sum( if(coalesce(ts.caller_total,0)=3, 1, if(coalesce(ts.callee_total,0)=3, 1, 0)) ) as d400_all from(select dt, (if (coalesce(split_part(caller_ping_delay1, ',', 3), 0)>=400,1,0) + if (coalesce(split_part(caller_ping_delay2, ',', 3),0)>=400, 1, 0) + if(coalesce(split_part(caller_ping_delay3, ',', 3), 0)>=400, 1, 0)) as caller_total, (if(coalesce(split_part(callee_ping_delay1, ',', 3),0)>=400,1,0) + if(coalesce(split_part(callee_ping_delay2, ',', 3), 0)>=400, 1, 0) + if(coalesce(split_part(callee_ping_delay3, ',', 3),0)>=400, 1, 0)) as callee_total from $tmp_table_name_m ) ts group by ts.dt ) d on d.dt=tall.dt  order by t2g.dt desc limit 100;"|odpscmd

echo "SET odps.stage.mapper.split.size = 32;select t.dt, t.total,t.xcah0, round((t.xcah0/total)*100, 2) as prexchx0, t.xcah1, round((t.xcah1/total)*100, 2) as prexchx1, t.xcah2, round((t.xcah2/total)*100, 2) as prexchx2, t.xcah3, round((t.xcah3/total)*100, 2) as prexchx2, t.xcah4, round((t.xcah4/total)*100, 2) as prexchx3, t.xcah5, round((t.xcah5/total)*100, 2) as prexchx3, t.xcah_gt5, round((t.xcah_gt5/total)*100, 2) as prexchgt5, t.delay400, round((t.delay400/total)*100, 2) as predelay400_pin3, t.valxch, round((t.valxch/total)*100, 2) as prexch, t.val2G, round((t.val2G/total)*100, 2) as pre2g, t.valyd3G, round((t.valyd3G/total)*100, 2) as preyd3G, t.val3G, round((t.val3G/total)*100, 2) as pre3g, t.val4G, round((t.val4G/total)*100, 2) as pre4g, t.valwifi, round((t.valwifi/total)*100, 2) as prewifi, t.valok, round((t.valok/total)*100, 2) as preok from (SELECT dt, count(DISTINCT call_id) AS total, count(distinct if(coalesce(caller_swithnet, 0)=0 and coalesce(callee_swithnet,0)=0 and (caller_netmode='2g' OR callee_netmode='2g'),call_id,null)) as val2G, count(distinct if(coalesce(caller_swithnet, 0)>0 or coalesce(callee_swithnet,0)>0,call_id,null)) as valxch, count(distinct if(coalesce(caller_swithnet,0)=0 and coalesce(callee_swithnet,0)=0 and ( (caller_netmode='3g' and caller_provider like '移动') or (callee_netmode='3g' and callee_provider like '移动')) ,call_id,null)) as valyd3G, count(distinct if(coalesce(caller_swithnet,0)=0 and callee_swithnet=0 and ( (caller_netmode='3g' and caller_provider not like '移动') and (callee_netmode='3g' and callee_provider not like '移动')) ,call_id,null)) as val3G, count(distinct if(coalesce(caller_swithnet,0)=0 and coalesce(callee_swithnet,0)=0 and caller_netmode='4g'  and callee_netmode='4g' ,call_id,null)) as val4G,  count(distinct if(coalesce(caller_swithnet,0)=0 and coalesce(callee_swithnet,0)=0 and caller_netmode='wifi'  and callee_netmode='wifi' ,call_id,null)) as valwifi, count(distinct if(coalesce(caller_swithnet,0)=0 and coalesce(callee_swithnet,0)=0 and (caller_netmode='wifi' or caller_netmode='4g' or (caller_netmode='3g' and caller_provider not like '移动') ) and (callee_netmode='wifi' or callee_netmode='4g' or (callee_netmode='3g' and callee_provider not like '移动') ), call_id, null)) as valok, count(distinct if(coalesce(caller_swithnet, 0) + coalesce(callee_swithnet, 0)=0, call_id, null)) as xcah0, count(distinct if(coalesce(caller_swithnet, 0) + coalesce(callee_swithnet, 0)=1, call_id, null)) as xcah1, count(distinct if(coalesce(caller_swithnet, 0) + coalesce(callee_swithnet, 0)=2, call_id, null)) as xcah2, count(distinct if(coalesce(caller_swithnet, 0) + coalesce(callee_swithnet, 0)=3, call_id, null)) as xcah3, count(distinct if(coalesce(caller_swithnet, 0) + coalesce(callee_swithnet, 0)=4, call_id, null)) as xcah4, count(distinct if(coalesce(caller_swithnet, 0) + coalesce(callee_swithnet, 0)=5, call_id, null)) as xcah5, count(distinct if(coalesce(caller_swithnet, 0) + coalesce(callee_swithnet, 0)>5, call_id, null)) as xcah_gt5, count(distinct if((coalesce(split_part(caller_ping_delay1, ',', 3), 0)>=400 and coalesce(split_part(caller_ping_delay2, ',', 3), 0)>=400 and coalesce(split_part(caller_ping_delay3, ',', 3), 0)>=400) or (coalesce(split_part(callee_ping_delay1, ',', 3), 0)>=400 and coalesce(split_part(callee_ping_delay2, ',', 3), 0)>=400 and coalesce(split_part(callee_ping_delay3, ',', 3), 0)>=400), call_id, null)) as delay400 from $tmp_table_name_m group by dt  order by dt limit 100 ) t order by t.dt desc limit 100;" | odpscmd

