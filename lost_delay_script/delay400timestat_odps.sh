#!/bin/bash

cd `dirname $0`
record_day=`date -d "1 day ago" +'%Y-%m-%d'`

echo "SET odps.stage.mapper.split.size = 32; select '$record_day' as dt, tb.outer_ip as ip, ta.hr, ta.cnt400 as c400, ta.total, if(ta.total>0, round(ta.cnt400/ta.total*100, 2), 0.00) as r400, if(ta.total>0, round(ta.sm/ta.total, 2), 0.00) as sm from (select ra.log_source as ip, datepart(get_json_object(ra.content, '$.content.time'), 'hh') as hr, sum(if(split_part(get_json_object(rb.content, '$.callupload[0].qosinfo.delay'), ',', 3) > 400,1,0)) as cnt400,  sum(if(split_part(get_json_object(rb.content, '$.callupload[0].qosinfo.delay'), ',', 3) >= 0.0,1,0)) as total, sum(get_json_object(ra.content, '$.content.tags.sessions_active')) as sm from ods_uxinapp_rtpp_d ra join ods_uxinapp_realreport_d rb on ra.dt='$record_day' and rb.dt='$record_day' and get_json_object(rb.content, '$.callupload[0].qosinfo.delay') is not NULL and split_part(get_json_object(rb.content, '$.callupload[0].qosinfo.delay'), ',', 3) < 30000 and get_calid(get_json_object(rb.content,'$.callupload[0].ugocallinfo.signaltrace'),get_json_object(rb.content,'$.callupload[0].calleephone')) = get_json_object(ra.content, '$.content.tags.c_c_id') join (select ra.log_source as ip, count(*) as cn from ods_uxinapp_rtpp_d ra join ods_uxinapp_realreport_d rb on ra.dt='$record_day' and rb.dt='$record_day' and get_json_object(rb.content, '$.callupload[0].qosinfo.delay') is not NULL  and  split_part(get_json_object(rb.content, '$.callupload[0].qosinfo.delay'), ',', 3) > 400 and split_part(get_json_object(rb.content, '$.callupload[0].qosinfo.delay'), ',', 3) < 30000 and get_calid(get_json_object(rb.content,'$.callupload[0].ugocallinfo.signaltrace'),get_json_object(rb.content,'$.callupload[0].calleephone')) = get_json_object(ra.content, '$.content.tags.c_c_id') group by  ra.log_source order by cn desc limit 1) ta on ra.log_source=ta.ip  group by ra.log_source, datepart(get_json_object(ra.content, '$.content.time'), 'hh') limit 24) ta join d_ecs_ip_rela tb on tb.inner_ip=ta.ip order by ta.hr limit 24;" | odpscmd


