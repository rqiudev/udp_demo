#!/bin/bash

cd `dirname $0`
record_day=`date -d "1 day ago" +'%Y-%m-%d'`

echo "SET odps.stage.mapper.split.size = 32; select '$record_day' as dt, ta.ip as rtppip, ta.hr, ta.cnt400 as c400, ta.stotal, if(ta.stotal>0, round(ta.cnt400/ta.stotal*100, 2), 0.00) as r400, if(ta.stotal>0, round(ta.sm/ta.stotal, 2), 0.00) as sm, if(ta.rcnt>0, round(ta.rtt/ta.rcnt, 2), 0.0) as rtt,ta.pcnt0, if(ta.pcnt0>0, round(ta.ttotal0/ta.pcnt0, 2), 0.00) as tave0, ta.delay0, if(ta.pcnt0>0, round(ta.delay0/ta.pcnt0*100, 2), 0.00) as rdelay0, ta.delay1, if(ta.pcnt0>0, round(ta.delay1/ta.pcnt0*100, 2), 0.00) as rdelay1, ta.delay2, if(ta.pcnt0>0, round(ta.delay2/ta.pcnt0*100, 2), 0.00) as rdelay2, ta.delay3, if(ta.pcnt0>0, round(ta.delay3/ta.pcnt0*100, 2), 0.00) as rdelay3, ta.delay4, if(ta.pcnt0>0, round(ta.delay4/ta.pcnt0*100, 2), 0.00) as rdelay4 from (select rd.outer_ip as ip, datepart(get_json_object(ra.content, '$.content.time'), 'hh') as hr, sum(if(split_part(get_json_object(rb.content, '$.callupload[0].qosinfo.delay'), ',', 3) > 400,1,0)) as cnt400,  sum(if(split_part(get_json_object(rb.content, '$.callupload[0].qosinfo.delay'), ',', 3) >= 0.0,1,0)) as stotal, sum(get_json_object(ra.content, '$.content.tags.sessions_active')) as sm, sum(get_json_object(re.content, '$.content.rtt')) as rtt, count(get_json_object(re.content, '$.content.rtt')) as rcnt, sum(get_json_object(re.content, '$.content.count0')) as pcnt0, round(sum(get_json_object(re.content, '$.content.count0')*get_json_object(re.content, '$.content.ave0')), 2) as ttotal0, sum(get_json_object(re.content, '$.content.delayStat0[0]')) as delay0, sum(get_json_object(re.content, '$.content.delayStat0[1]')) as delay1, sum(get_json_object(re.content, '$.content.delayStat0[2]')) as delay2, sum(get_json_object(re.content, '$.content.delayStat0[3]')) as delay3, sum(get_json_object(re.content, '$.content.delayStat0[4]')) as delay4 from ods_uxinapp_rtpp_d ra join ods_uxinapp_realreport_d rb on ra.dt='$record_day' and rb.dt='$record_day' and get_json_object(rb.content, '$.callupload[0].qosinfo.delay') is not NULL and split_part(get_json_object(rb.content, '$.callupload[0].qosinfo.delay'), ',', 3) < 30000 and get_calid(get_json_object(rb.content,'$.callupload[0].ugocallinfo.signaltrace'),get_json_object(rb.content,'$.callupload[0].calleephone')) = get_json_object(ra.content, '$.content.tags.c_c_id') join (select ra.log_source as ip, count(*) as cn from ods_uxinapp_rtpp_d ra join ods_uxinapp_realreport_d rb on ra.dt='$record_day' and rb.dt='$record_day' and get_json_object(rb.content, '$.callupload[0].qosinfo.delay') is not NULL  and  split_part(get_json_object(rb.content, '$.callupload[0].qosinfo.delay'), ',', 3) > 400 and split_part(get_json_object(rb.content, '$.callupload[0].qosinfo.delay'), ',', 3) < 30000 and get_calid(get_json_object(rb.content,'$.callupload[0].ugocallinfo.signaltrace'),get_json_object(rb.content,'$.callupload[0].calleephone')) = get_json_object(ra.content, '$.content.tags.c_c_id') group by  ra.log_source order by cn desc limit 1) rc on ra.log_source=rc.ip join d_ecs_ip_rela rd on rd.inner_ip=rc.ip join ods_uxinapp_rtpp_monitor_d re on re.dt='$record_day' and get_json_object(re.content, '$.content.rtpp')=rd.outer_ip and datepart(get_json_object(re.content, '$.content.time'), 'hh')=datepart(get_json_object(ra.content, '$.content.time'), 'hh') group by rd.outer_ip, datepart(get_json_object(ra.content, '$.content.time'), 'hh') limit 24) ta order by ta.hr limit 24;" | odpscmd


